import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { EyeIcon, EyeSlashIcon, ChevronRightIcon, UserIcon, BuildingOfficeIcon, BuildingLibraryIcon, EnvelopeIcon, MapPinIcon, ArrowPathIcon } from '@heroicons/react/24/outline';
import { signInWithGoogle, signInWithEmail, signUpStoreAdmin, resetPassword, handleRedirectResult } from '../firebase/auth';
import { shouldUseRedirect, hasProblematicUserAgent } from '../utils/deviceDetector';

interface LoginFormData {
  email: string;
  password: string;
  confirmPassword: string;
  storeName: string;
  phoneNumber: string;
  extraEmail: string; // ë³¸ì‚¬ ê´€ë¦¬ììš© Gmail (Google ë¡œê·¸ì¸ì—ì„œë§Œ ì‚¬ìš©)
  location: string; // ìœ„ì¹˜ ì •ë³´ ì¶”ê°€
  country?: string; // êµ­ê°€
  province?: string; // ë„
  city?: string; // ì‹œ
}

export const Login: React.FC = () => {
  const navigate = useNavigate();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [isSignUp, setIsSignUp] = useState(false);
  const [rememberMe, setRememberMe] = useState(false);
  const [locationLoading, setLocationLoading] = useState(false);
  const [locationError, setLocationError] = useState('');
  const [showPasswordReset, setShowPasswordReset] = useState(false);
  const [resetEmail, setResetEmail] = useState('');

  // ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
  const getCurrentLocation = async () => {
    setLocationLoading(true);
    setLocationError('');

    if (!navigator.geolocation) {
      setLocationError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
      setLocationLoading(false);
      return;
    }

    navigator.geolocation.getCurrentPosition(
      async (position) => {
        const { latitude, longitude } = position.coords;

        try {
          // OpenStreetMap Nominatim APIë¡œ ì£¼ì†Œ ë³€í™˜
          const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&accept-language=ko&extratags=1&namedetails=1`
          );
          const data = await response.json();

          if (data && data.address) {
            const address = data.address;
            const country = address.country || '';
            const province = address.state || address.province || '';
            const city = address.city || address.town || address.village || '';

            // ìœ„ì¹˜ ì •ë³´ë¥¼ ê°œë³„ í•„ë“œë¡œ ì €ì¥
            setFormData(prev => ({
              ...prev,
              country,
              province,
              city,
              location: `${country} ${province} ${city}`.trim()
            }));
          } else {
            setFormData(prev => ({ ...prev, location: 'ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }));
          }
        } catch (err) {
          console.error('ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨:', err);
          setFormData(prev => ({ ...prev, location: 'ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨' }));
        }

        setLocationLoading(false);
      },
      (error) => {
        setLocationLoading(false);

        switch (error.code) {
          case error.PERMISSION_DENIED:
            setLocationError('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
            break;
          case error.POSITION_UNAVAILABLE:
            setLocationError('ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            break;
          case error.TIMEOUT:
            setLocationError('ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤');
            break;
          default:
            setLocationError('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  };

  // ê°€ì… ëª¨ë“œë¡œ ì „í™˜ ì‹œ ìœ„ì¹˜ ì •ë³´ ìë™ ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    if (isSignUp && !formData.location) {
      getCurrentLocation();
    }
  }, [isSignUp]);

  // ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ ì²˜ë¦¬ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
  useEffect(() => {
    const checkRedirectResult = async () => {
      try {
        const result = await handleRedirectResult();
        if (result.success) {
          console.log('Redirect login successful, navigating to redirect page...');
          // AuthContext ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          await new Promise(resolve => setTimeout(resolve, 800));
          navigate('/redirect');
        } else if (result.error && !result.error.includes('ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤')) {
          // ë¦¬ë””ë ‰ì…˜ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°ëŠ” ì •ìƒì ì¸ ìƒí™©ì´ë¯€ë¡œ ì—ëŸ¬ í‘œì‹œ ì•ˆ í•¨
          setError(result.error);
        }
      } catch (error) {
        console.error('Redirect result check failed:', error);
      }
    };

    checkRedirectResult();
  }, [navigate]);

  // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ê²½ê³  í™•ì¸
  useEffect(() => {
    if (loginType === 'hq' && hasProblematicUserAgent()) {
      setShowMobileWarning(true);
    } else {
      setShowMobileWarning(false);
    }
  }, [loginType]);

  const [formData, setFormData] = useState<LoginFormData>({
    email: '',
    password: '',
    confirmPassword: '',
    storeName: '',
    phoneNumber: '',
    extraEmail: '', // ë³¸ì‚¬ ê´€ë¦¬ììš©
    location: '', // ìœ„ì¹˜ ì •ë³´ ì´ˆê¸°ê°’
    country: '', // êµ­ê°€ ì´ˆê¸°ê°’
    province: '', // ë„ ì´ˆê¸°ê°’
    city: '' // ì‹œ ì´ˆê¸°ê°’
  });

  // "ê¸°ì–µí•˜ê¸°" ê¸°ëŠ¥ - ì´ë©”ì¼ ì €ì¥/ë³µì›
  useEffect(() => {
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì´ë©”ì¼ ë³µì›
    const savedEmail = localStorage.getItem('rememberedEmail');
    if (savedEmail && !isSignUp) {
      setFormData(prev => ({ ...prev, email: savedEmail }));
      setRememberMe(true);
    }
  }, [isSignUp]);

  // "ê¸°ì–µí•˜ê¸°" ìƒíƒœ ë³€ê²½ ì‹œ ì´ë©”ì¼ ì €ì¥/ì‚­ì œ
  useEffect(() => {
    if (rememberMe && formData.email) {
      localStorage.setItem('rememberedEmail', formData.email);
    } else {
      localStorage.removeItem('rememberedEmail');
    }
  }, [rememberMe, formData.email]);

  // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦ ìƒíƒœ
  const [emailError, setEmailError] = useState('');
  const [isEmailValid, setIsEmailValid] = useState(true);

  // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦ í•¨ìˆ˜
  const validateEmail = (email: string): boolean => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };

  // í†µí•© ì…ë ¥ í•¸ë“¤ëŸ¬ (ì´ë©”ì¼ ê²€ì¦ í¬í•¨)
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));

    // ì´ë©”ì¼ ì‹¤ì‹œê°„ ê²€ì¦ (ë¶€ë“œëŸ½ê²Œ ì²˜ë¦¬)
    if (name === 'email') {
      if (value && !validateEmail(value)) {
        setEmailError('ì´ë©”ì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        setIsEmailValid(false);
      } else {
        setEmailError('');
        setIsEmailValid(true);
      }
    }
  };

  // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í•¸ë“¤ëŸ¬
  const handlePasswordReset = async () => {
    if (!resetEmail) {
      setError('ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!validateEmail(resetEmail)) {
      setError('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
      return;
    }

    setIsLoading(true);
    setError('');
    setSuccess('');

    try {
      const result = await resetPassword(resetEmail);
      if (result.success) {
        setSuccess(result.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.');
        setShowPasswordReset(false);
        setResetEmail('');
      } else {
        setError(result.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      setError('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsLoading(false);
    }
  };

  const handleGoogleLogin = async () => {
    setIsLoading(true);
    setError('');

    try {
      const result = await signInWithGoogle();
      if (result.success) {
        // ë¦¬ë””ë ‰ì…˜ ë°©ì‹ì¸ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ í›„ ëŒ€ê¸°
        if (result.error && result.error.includes('ë¦¬ë””ë ‰ì…˜')) {
          setSuccess(result.error);
          // ë¦¬ë””ë ‰ì…˜ì€ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì¶”ê°€ ì•¡ì…˜ ë¶ˆí•„ìš”
        } else {
          // íŒì—… ë°©ì‹ ì„±ê³µ ì‹œ
          console.log('Google login successful, waiting for AuthContext update...');
          await new Promise(resolve => setTimeout(resolve, 800));
          navigate('/redirect');
        }
      } else {
        setError(result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error('Google login error:', err);
      setError('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      // ë¦¬ë””ë ‰ì…˜ ë°©ì‹ì¸ ê²½ìš° ë¡œë”© ìƒíƒœ ìœ ì§€ (í˜ì´ì§€ ì´ë™ ì˜ˆìƒ)
      if (!success || !success.includes('ë¦¬ë””ë ‰ì…˜')) {
        setIsLoading(false);
      }
    }
  };

  const handleEmailAuth = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');
    setSuccess('');

    try {
      // ì´ë©”ì¼ ìœ íš¨ì„± ê²€ì¦
      if (!validateEmail(formData.email)) {
        setError('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
        setIsLoading(false); // ğŸ†• ì¦‰ì‹œ ë¡œë”© í•´ì œ
        return;
      }

      if (isSignUp) {
        // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ê²€ì¦
        if (formData.password !== formData.confirmPassword) {
          setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          setIsLoading(false); // ğŸ†• ì¦‰ì‹œ ë¡œë”© í•´ì œ
          return;
        }

        const result = await signUpStoreAdmin(
          formData.email,
          formData.password,
          formData.storeName,
          formData.phoneNumber,
          formData.location, // ìœ„ì¹˜ ì •ë³´ ì¶”ê°€
          formData.extraEmail, // ì¶”ê°€ ì´ë©”ì¼ ì •ë³´ ì¶”ê°€
          formData.country // êµ­ê°€ ì •ë³´ ì¶”ê°€
        );

        // ğŸ†• ê°€ì… ê²°ê³¼ ì²˜ë¦¬ í›„ ì¦‰ì‹œ ë¡œë”© í•´ì œ
        if (result.success) {
          setSuccess(result.error || 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          setIsSignUp(false);
          setFormData({ email: '', password: '', confirmPassword: '', storeName: '', phoneNumber: '', extraEmail: '', location: '', country: '', province: '', city: '' });
        } else {
          setError(result.error || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        setIsLoading(false); // ğŸ†• ê°€ì… ì²˜ë¦¬ í›„ ì¦‰ì‹œ ë¡œë”© í•´ì œ
        return; // ğŸ†• early returnìœ¼ë¡œ finally ë¸”ë¡ ì‹¤í–‰ ë°©ì§€
      } else {
        const result = await signInWithEmail(formData.email, formData.password);
        if (result.success) {
          // AuthContext ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          console.log('Email login successful, waiting for AuthContext update...');
          await new Promise(resolve => setTimeout(resolve, 800));
          navigate('/redirect');
        } else {
          setError(result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        setIsLoading(false); // ğŸ†• ë¡œê·¸ì¸ ì²˜ë¦¬ í›„ ì¦‰ì‹œ ë¡œë”© í•´ì œ
        return; // ğŸ†• early returnìœ¼ë¡œ finally ë¸”ë¡ ì‹¤í–‰ ë°©ì§€
      }
    } catch (err) {
      console.error('Auth error:', err); // ğŸ†• ì—ëŸ¬ ë¡œê¹… ê°•í™”
      setError('ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      setIsLoading(false); // ğŸ†• ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ë¡œë”© í•´ì œ
    }
  };

  const handlePasswordReset = async () => {
    if (!resetEmail) {
      setError('ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!validateEmail(resetEmail)) {
      setError('ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.');
      return;
    }

    setIsLoading(true);
    setError('');
    setSuccess('');

    try {
      const result = await resetPassword(resetEmail);
      if (result.success) {
        setSuccess(result.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.');
        setShowPasswordReset(false);
        setResetEmail('');
      } else {
        setError(result.error || 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (err) {
      console.error('Password reset error:', err);
      setError('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setIsLoading(false);
    }
  };

  const validateEmail = (email) => {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  };

  return (
    <div className="min-h-screen bg-gray-950 flex items-center justify-center p-4">
      <div className="mobile-login-container">
        {/* í—¤ë” */}
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-cyan-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
            <BuildingOfficeIcon className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-3xl font-bold text-white mb-2">
            ìŠ¤í¬ë¦°ê³¨í”„ ê´€ë¦¬ ì‹œìŠ¤í…œ
          </h1>
          <p className="text-gray-400">
            ëª¨ë“  ê´€ë¦¬ìë¥¼ ìœ„í•œ í†µí•© ë¡œê·¸ì¸
          </p>
        </div>

        {/* ë‹¨ì¼ ë¡œê·¸ì¸ í¼ */}
        <h3 className="text-xl font-bold text-white mb-4 text-center">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</h3>
        <p className="text-gray-300 text-sm mb-6 text-center">
          ê°€ì…í•˜ì‹  ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì‹œë©´ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë§í¬ë¥¼ ë°œì†¡í•´ ë“œë¦½ë‹ˆë‹¤.
        </p>
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              ì´ë©”ì¼ ì£¼ì†Œ
            </label>
            <input
              type="email"
              value={resetEmail}
              onChange={(e) => setResetEmail(e.target.value)}
              autoComplete="username"
              className="w-full px-3 py-2 bg-gray-800/50 border border-gray-700/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500/50 transition-all duration-300"
              placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            />
          </div>
          <div className="flex space-x-3">
            <button
              onClick={() => {
                setShowPasswordReset(false);
                setResetEmail('');
                setError('');
                setSuccess('');
              }}
              className="flex-1 px-4 py-2 bg-gray-700 text-white rounded-xl hover:bg-gray-600 transition-colors duration-300"
            >
              ì·¨ì†Œ
            </button>
            <button
              onClick={handlePasswordReset}
              disabled={isLoading}
              className="flex-1 px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl hover:from-cyan-700 hover:to-blue-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isLoading ? 'ë°œì†¡ ì¤‘...' : 'ë§í¬ ë°œì†¡'}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
    </div >
  );
};

export default Login;
