# 대시보드 기능 설명

## 📊 주요 기능
- 수익 통계: 일별/월별/연별 데이터 시각화
- 거래 분석: 게임 기록 및 결제 내역
- 실시간 데이터: Firestore 실시간 업데이트

## 관리자별 이동 방식
1.본사 관리자 
 -매장관리자에서 매장을 선택하면 매장별 대시보드로 이동
- 대시보드로 이동후 매장 버튼, 일별 버튼 활성화
- 매장 선택에는  선택한 매장 아이템이 선택되어야함.
- 그래프, 매출상세에 데이터값 적용

2.매장 관리자
-매장관리자에서 매장을 선택하면 매장별 대시보드로 이동
- 대시보드로 이동후 매장 버튼, 일별 버튼 활성화
- 매장 선택에는 선택한 매장 아이템이 선택되어야함.
- 전체, 매장 버튼, 매장 버튼 숨기기

## 관리자별 데이터 처리 방식
1.본사 관리자 
 -[전체] [매장]  [일별] [월별] [년별]  [날짜선택기] 에 따른 
   그래프, 매출상세에 데이터값 적용


2.매장 관리자
- 해당 매장에 따른 데이터를  그래프, 매출상세에 데이터값 적용




## 현재 구현된 레이아웃 구조

### 전체 페이지 레이아웃
```
┌─────────────────────────────────────────────────────────────┐
│                    대시보드 헤더                            │
│  [매출 통계] 또는 [내 매장 통계] 또는 [매장명 통계]          │
├─────────────────────────────────────────────────────────────┤
│                    컨트롤 패널                              │
│  [전체] [매장]  [일별] [월별] [년별]  [날짜선택기]          │
├─────────────────────────────────────────────────────────────┤
│                    통계 카드                                │
│  ┌─────────────┐  ┌─────────────┐                        │
│  │   총 매출    │  │   총 거래    │                        │
│  │  ₩1,234,567 │  │    123건     │                        │
│  └─────────────┘  └─────────────┘                        │
├─────────────────────────────────────────────────────────────┤
│                 매장 선택 (HQ 사용자, 매장 모드시)          │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │  매장 선택: [드롭다운 메뉴]                           │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    매출 그래프                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              막대 그래프 (Recharts)                    │ │
│  │  00:00 ████  01:00 ██████  02:00 █████                │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    매출 상세 테이블                         │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 기간 │   매출   │ 거래수 │ 객단가 │                    │ │
│  │ 14:00│ ₩150,000 │   3건  │ ₩50,000│                    │ │
│  │ 15:00│ ₩200,000 │   4건  │ ₩50,000│                    │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 모바일 레이아웃
```
┌─────────────────────┐
│   매출 통계         │
├─────────────────────┤
│ [전체] [매장]       │
│ [일별] [월별] [년별] [날짜선택기]   │
│                      │
├─────────────────────┤
│ ┌─────────┐ ┌─────────┐│
│ │총 매출  │ │총 거래  ││
│ │₩1,234,567│ │ 123건  ││
│ └─────────┘ └─────────┘│
├─────────────────────┤
│     매출 그래프      │
│   (반응형 차트)     │
├─────────────────────┤
│     매출 상세        │
│ ┌─────────────────┐ │
│ │ 14:00           │ │
│ │ ₩150,000       │ │
│ │ 거래수: 3건     │ │
│ │ 객단가: ₩50,000 │ │
│ └─────────────────┘ │
│ ┌─────────────────┐ │
│ │ 15:00           │ │
│ │ ₩200,000       │ │
│ │ 거래수: 4건     │ │
│ │ 객단가: ₩50,000 │ │
│ └─────────────────┘ │
└─────────────────────┘
```

## 주요 UI 요소 상세 설명

### 1. 헤더 섹션
- **위치**: 페이지 최상단
- **내용**: 사용자 역할에 따른 동적 제목
  - 본사 관리자: "매출 통계"
  - 매장 관리자: "내 매장 통계"
  - 특정 매장 조회: "[매장명] 통계"

### 2. 컨트롤 패널
- **위치**: 헤더 하단
- **구성요소**:
  - **뷰 모드 토글** (HQ 사용자만): [전체] [매장] 버튼
  - **기간 선택**: [일별] [월별] [년별] 버튼
  - **날짜 선택기**: 달력 형식의 입력 필드

### 3. 통계 카드
- **위치**: 컨트롤 패널 하단
- **구조**: 2열 그리드 레이아웃
- **내용**:
  - 왼쪽: 총 매출 (원화 포맷)
  - 오른쪽: 총 거래수 (건 단위)

### 4. 매장 선택 드롭다운
- **표시 조건**: HQ 사용자 + 매장 모드
- **위치**: 통계 카드 하단
- **기능**: 특정 매장 선택 가능

### 5. 매출 그래프
- **위치**: 중앙 영역
- **타입**: 동적 막대 그래프 (Recharts 라이브러리)
- **특징**: 
  - 반응형 디자인
  - 시간대별/일별/월별 데이터 표시
  - 호버 시 상세 정보 표시

### 6. 매출 상세 테이블
- **위치**: 페이지 하단
- **반응형**:
  - **PC**: 테이블 형태 (기간, 매출, 거래수, 객단가)
  - **모바일**: 카드 형태 (기간별로 그룹화)

## 주요 버튼 및 인터랙션

### 버튼 요소
1. **전체/매장 토글**
   - 위치: 컨트롤 패널 좌측
   - 상태: 활성화된 버튼은 파란색 배경

2. **기간 선택 버튼**
   - 위치: 컨트롤 패널 중앙
   - 옵션: 일별, 월별, 년별
   - 상태: 활성화된 버튼은 파란색 배경

3. **날짜 선택기**
   - 위치: 컨트롤 패널 우측
   - 타입: HTML5 date input
   - 터치 최적화 (모바일)

### 데이터 표시 방식
- **실시간 업데이트**: Firestore 실시간 리스너
- **데이터 소스**: `settlements_{countryCode}` 컬렉션
- **권한별 필터링**: 사용자 역할에 따른 데이터 접근 제어

## 반응형 특징
- **모바일 최적화**: 터치 타겟 크기 확장
- **테이블 대체**: 모바일에서는 카드 레이아웃으로 전환
- **가로 스크롤**: 모바일에서 컨트롤 버튼 그룹 스크롤 지원

## 🔄 버튼 기능 개선 플랜

### 🔍 현재 구현 상태 정확한 분석

#### ✅ 이미 올바르게 구현된 기능
- **기간 선택 버튼** (일별/월별/년별): 정상 동작
- **전체/매장 버튼**: HQ 사용자에게만 표시됨 (이미 올바름)
- **데이터 연동**: useEffect로 상태 변경 시 데이터 재조회

#### ⚠️ 문서와 실제 코드 불일치 사항
- **문서 오해**: "매장 관리자에게 전체/매장 버튼 숨기기" 필요
- **실제 코드**: `{user?.role === 'hq' && (...)}` - 이미 HQ 사용자에게만 표시
- **결론**: 현재 구현이 올바름, 문서만 수정 필요

### 🎯 실제 동작 방식 상세화

#### 1. 사용자 역할별 동작 흐름
```
[본사 관리자 (role: 'hq')]
├── 전체 모드: 모든 매장 데이터 조회
├── 매장 모드: 드롭다운에서 특정 매장 선택
├── 전체/매장 토글 버튼 표시됨
└── URL 파라미터로 특정 매장 직접 접근 가능

[매장 관리자 (role: 'store')]
├── 자동으로 자기 매장 데이터만 표시
├── 전체/매장 토글 버튼 없음 (자동으로 매장 모드)
├── 다른 매장 접근 시도 시 권한 없음 에러
└── storeId 자동 생성: generateStoreId(user.email)
```

#### 2. 초기 상태 설정 복잡성 (3가지 경로)
```tsx
// 경로 1: 새 URL 파라미터 방식
/dashboard?mode=store&storeId=store1@example.com

// 경로 2: 구버전 호환성 방식  
/dashboard?store=store1@example.com&country=KR

// 경로 3: 매장 관리자 자동 설정
const isStoreManager = user?.role === 'store';
const storeId = isStoreManager && user.email ? generateStoreId(user.email) : null;
```

#### 3. 데이터 조회 실제 흐름
```
1. 사용자 역할 및 모드 확인
2. countryCode 결정 (여러 국가 시도)
3. Firestore 쿼리 실행 (settlements_{countryCode})
4. 클라이언트 측 storeId 필터링 (임시 조치)
5. 기간별 데이터 집계 (aggregateRevenueData)
6. 그래프 및 테이블 업데이트
```

### 🔧 기술적 구현 세부사항

#### 권한 제어 메커니즘
```tsx
// 매장 관리자 접근 제어
if (user?.role === 'store' && targetStore && targetStore !== user.email) {
  console.warn('⚠️ 접근 권한 없음: 매장 관리자가 다른 매장 통계 접근 시도');
  setLoading(false);
  return;
}
```

#### 에러 처리 및 폴백 로직
```tsx
// countryCode 찾기 실패 시 폴백
if (!countryCode && user?.email) {
  const storeUserData = await fetchStoreUserData(user.email);
  if (storeUserData?.countryCode) {
    countryCode = storeUserData.countryCode;
  }
}
```

#### 성능 최적화 (임시 조치)
```tsx
// 서버 측 인덱스 문제로 클라이언트 필터링
let filteredSettlements = settlements;
if (effectiveStoreId) {
  filteredSettlements = settlements.filter(s => s.storeId === effectiveStoreId);
}
```

### 📋 수정할 필요 없는 기능들

#### 1. 전체/매장 버튼 표시 로직
```tsx
// 현재 코드가 이미 올바름
{user?.role === 'hq' && (
  <div className="flex bg-gray-700/50 rounded-lg p-1 w-fit">
    <button onClick={() => { setViewMode('all'); setSelectedStoreId(null); }}>전체</button>
    <button onClick={() => setViewMode('store')}>매장</button>
  </div>
)}
// 매장 관리자는 자동으로 버튼 없이 자기 매장 데이터 표시
```

#### 2. 버튼 클릭 시 데이터 흐름
```
✅ 이미 구현됨: 버튼 클릭 → 상태 변경 → useEffect 트리거 → fetchRevenueData() → 데이터 집계 → UI 업데이트
```

### 🧪 정확한 테스트 및 검증 방법

#### 시나리오별 테스트 케이스
```
시나리오 1: 본사 관리자 로그인 → 전체 모드 → 일별 데이터 확인
시나리오 2: 본사 관리자 → 매장 모드 → 드롭다운에서 매장 선택
시나리오 3: 매장 관리자 로그인 → 자기 매장 데이터만 표시
시나리오 4: URL 파라미터로 직접 매장 접근 (/dashboard?mode=store&storeId=xxx)
시나리오 5: 매장 관리자가 다른 매장 접근 시도 → 권한 없음 에러
```

#### 데이터 흐름 디버깅 방법
```tsx
// 콘솔 로그로 상태 흐름 확인
console.log('🔄 상태 변경:', { periodType, viewMode, selectedStoreId });
console.log('👤 사용자 정보:', { email: user?.email, role: user?.role });
console.log('📊 데이터 조회 결과:', { 
  totalSettlements: settlements.length, 
  filteredSettlements: filteredSettlements.length 
});
```

### 🎯 최종 결론

#### ✅ 이미 올바르게 구현된 기능
- 전체/매장 버튼 표시 로직
- 데이터 연동 메커니즘  
- 사용자 역할별 권한 제어
- URL 파라미터 초기화

#### 📝 문서만 수정할 내용
- 현재 구현 상태를 정확하게 반영
- 복잡한 초기화 로직 상세 설명
- 실제 동작 방식과 코드 일치화

#### 🔮 향후 개선 방향
- 서버 측 인덱스 문제 해결으로 클라이언트 필터링 제거
- 더 나은 에러 처리 및 사용자 피드백
- 성능 최적화 및 로딩 상태 개선

## � 가상매장 사용금지 정책

### 금지 사항
- **테스트 매장 하드코딩 금지**: 실제 운영 환경에서는 가상/테스트 매장 데이터를 하드코딩할 수 없음
- **Mock 데이터 사용 제한**: 실제 매장 데이터가 있는 경우 Mock 데이터 사용 금지
- **더미 데이터 삽입 금지**: 실제 Firestore에 테스트용 가상 데이터 직접 삽입 금지

### 현재 위반 사항 발견
```tsx
// ❌ 현재 하드코딩된 테스트 매장 (수정 필요)
<option value="store1">테스트 매장 1</option>
<option value="store2">테스트 매장 2</option>

// ❌ 현재 Mock 데이터 (수정 필요)
const mockData: RevenueData[] = [
  { period: '00:00', revenue: 150000, count: 3, date: new Date() },
  // ...
];
```

### 올바른 구현 방식
```tsx
// ✅ 실제 매장 데이터 동적 로드
const [stores, setStores] = useState<Store[]>([]);
useEffect(() => {
  fetchStores().then(setStores);
}, []);

// ✅ 실제 데이터가 없을 때만 적절한 메시지 표시
if (revenueData.length === 0) {
  return <div>해당 기간의 매출 데이터가 없습니다.</div>;
}
```

### 개선 계획
1. **실제 매장 데이터 로드**: Firestore에서 실제 매장 목록 동적 조회 ✅ 완료
2. **Mock 데이터 제거**: 실제 데이터 기반으로만 동작하도록 수정 ✅ 완료
3. **적절한 빈 상태 처리**: 데이터 없을 때 사용자 친화적 메시지 표시 ✅ 완료

## ✅ 수정 완료된 내용 상세 검토

### 🎯 가상매장 사용금지 정책 적용 완료

#### 1. **테스트 매장 하드코딩 제거** ✅
```tsx
// ❌ 이전 코드 (제거됨)
<option value="store1">테스트 매장 1</option>
<option value="store2">테스트 매장 2</option>

// ✅ 수정된 코드
{stores.map((store) => (
  <option key={store.id} value={store.id}>
    {store.name}
  </option>
))}
```

#### 2. **Mock 데이터 완전 제거** ✅
```tsx
// ❌ 이전 코드 (제거됨)
const mockData: RevenueData[] = [...];
const displayData = revenueData.length > 0 ? revenueData : mockData;

// ✅ 수정된 코드
// � 가상매장 사용금지: Mock 데이터 제거 - 실제 데이터만 사용
// 실제 운영 환경에서는 가상 데이터를 사용할 수 없음
```

#### 3. **실제 매장 데이터 동적 로드 구현** ✅
```tsx
// ✅ 새로 구현된 기능
interface Store {
  id: string;
  name: string;
  email: string;
  countryCode: string;
}

const fetchStores = async (countryCode: string): Promise<Store[]> => {
  // Firestore에서 실제 매장 목록 조회
};

// 실제 매장 목록 상태 관리
const [stores, setStores] = useState<Store[]>([]);
const [storesLoading, setStoresLoading] = useState(true);
```

#### 4. **적절한 빈 상태 처리** ✅
```tsx
// ✅ 데이터 없을 때 사용자 친화적 메시지
{revenueData.length > 0 ? (
  <DynamicBarChart data={revenueData} />
) : (
  <div className="flex items-center justify-center h-64">
    <p className="text-gray-400">해당 기간의 매출 데이터가 없습니다.</p>
  </div>
)}
```

### 🔧 기술적 개선 사항

#### 1. **타입 안전성 강화** ✅
- 모든 파라미터에 명시적 타입 지정
- TypeScript 오류 모두 해결

#### 2. **로딩 상태 개선** ✅
- 매장 목록 로딩 인디케이터 추가
- 사용자에게 로딩 상태 시각적 피드백

#### 3. **에러 처리 강화** ✅
- 실제 데이터 없을 때 적절한 메시지 표시
- 네트워크 오류 시 graceful fallback

### 📋 수정 지시 대비 검토 결과

| 수정 지시사항 | 구현 완료 여부 | 상세 내용 |
|-------------|---------------|-----------|
| 가상매장 사용금지 | ✅ 완료 | 하드코딩된 테스트 매장 제거 |
| Mock 데이터 제거 | ✅ 완료 | 실제 데이터만 사용하도록 수정 |
| 실제 매장 데이터 로드 | ✅ 완료 | Firestore 동적 조회 구현 |
| 빈 상태 처리 | ✅ 완료 | 사용자 친화적 메시지 표시 |
| 타입 안전성 | ✅ 완료 | TypeScript 오류 모두 해결 |

### 🚀 배포 준비 완료
- 모든 가상 데이터 제거 ✅
- 실제 데이터 기반 동작 ✅
- 타입 오류 모두 해결 ✅
- 사용자 경험 개선 ✅

## ��📋 실제 구현 상세 정보

### 현재 코드 상태 (Dashboard.tsx 기준)
```tsx
// 1. 상태 관리
const [periodType, setPeriodType] = useState<PeriodType>('daily');
const [viewMode, setViewMode] = useState<ViewMode>('all');
const [selectedStoreId, setSelectedStoreId] = useState<string | null>(null);

// 2. useEffect 의존성 배열
useEffect(() => {
  if (user) {
    fetchRevenueData();
  }
}, [periodType, selectedDate, user?.email, viewMode, selectedStoreId]);

// 3. URL 파라미터 처리
React.useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const mode = urlParams.get('mode');
  const storeId = urlParams.get('storeId');

  if (mode === 'store' && storeId) {
    setViewMode('store');
    setSelectedStoreId(storeId);
  } else {
    setViewMode('all');
    setSelectedStoreId(null);
  }
}, []);
```

### 매장 관리자 초기 상태 설정
```tsx
// 매장 관리자는 자동으로 자기 매장 데이터만 표시
const isStoreManager = user?.role === 'store';
const storeId = isStoreManager && user.email ? generateStoreId(user.email) : null;

// 매장 관리자에게는 전체/매장 버튼 숨김
{user?.role === 'hq' && (
  <div className="flex bg-gray-700/50 rounded-lg p-1 w-fit">
    // 전체/매장 버튼
  </div>
)}
```

### URL 파라미터 전달 방식
```
// 매장관리자 페이지에서 대시보드로 이동 시
/dashboard?mode=store&storeId=store1@example.com

// 구버전 방식 (하위 호환성)
/dashboard?store=store1@example.com&country=KR
```

## 🧪 테스트 및 검증 방법

### 1. 버튼 기능 테스트
- **HQ 사용자**: 전체/매장 버튼 클릭 시 viewMode 변경 확인
- **매장 관리자**: 전체/매장 버튼이 숨겨져 있는지 확인
- **기간 버튼**: 일별/월별/년별 클릭 시 그래프 데이터 변경 확인

### 2. 데이터 반영 확인
```tsx
// 콘솔 로그로 데이터 흐름 확인
console.log('🔄 상태 변경:', { periodType, viewMode, selectedStoreId });
console.log('📊 데이터 조회 결과:', revenueData);
```

### 3. 초기 상태 테스트
- 매장관리자 페이지에서 매장 선택 후 대시보드 이동
- URL 파라미터가 제대로 전달되는지 확인
- 초기 상태가 올바르게 설정되는지 확인

## 🔧 추가 개선 사항

### 1. 모바일 레이아웃 수정
```
// 매장 관리자 모바일 레이아웃 (전체/매장 버튼 없음)
┌─────────────────────┐
│   내 매장 통계      │  ← 제목 변경
├─────────────────────┤
│ [일별] [월별] [년별]│  ← 전체/매장 버튼 제거
│ [날짜선택기]        │
├─────────────────────┤
│     ... 이하 동일   │
└─────────────────────┘
```

### 2. 로딩 상태 개선
- 각 버튼 클릭 시 로딩 인디케이터 표시
- 데이터 조회 중임을 시각적으로 표시

### 3. 에러 처리
- 데이터 조회 실패 시 에러 메시지 표시
- 네트워크 오류 시 재시도 버튼 제공
